
## Part 1. Настройка **gitlab-runner**

##### Подними виртуальную машину *Ubuntu Server 22.04 LTS*.

![img](attachments/1.1.png)

##### Скачай и установи на виртуальную машину **gitlab-runner**.

![img](attachments/1.2.png)
![img](attachments/1.3.png)


##### Запусти **gitlab-runner** и зарегистрируй его для использования в текущем проекте (*DO6_CICD*).

![img](attachments/1.4.png)

## Part 2. Сборка

##### Напиши этап для **CI** по сборке приложений из проекта *C3_SimpleBashUtils*.

Устанавливаю **make** и **gcc** на сервер с **gitlab-runner**:

![img](attachments/2.1.png)

Проверяю версии:

![img](attachments/2.2.png)

##### В файле _gitlab-ci.yml_ добавь этап запуска сборки через мейк файл из проекта _C3_.

Создаю в корне репозитория файл **gitlab-ci.yml** со следующей структурой:

![img](attachments/2.3.png)

После пуша коммита выполняется пайплайн со сборкой:

![img](attachments/2.4.png)

Логи сборки:

![img](attachments/2.5.png)

##### Файлы, полученные после сборки (артефакты), сохрани в произвольную директорию со сроком хранения 30 дней.

![img](attachments/2.6.png)
![img](attachments/2.7.png)

## Part 3. Тест кодстайла

#### Напиши этап для **CI**, который запускает скрипт кодстайла (*clang-format*).

Устанавливаю **clang-format** на сервер с **gitlab-runner**:

![img](attachments/3.1.png)

Проверяю версию:

![img](attachments/3.2.png)

##### Если кодстайл не прошел, то «зафейли» пайплайн.
##### В пайплайне отобрази вывод утилиты *clang-format*.

Обновленная структура файла **gitlab-ci.yml**:

![img](attachments/3.3.png)

После пуша коммита выполняется пайплайн с тестом кодстайла:

![img](attachments/3.4.png)

Логи тестом кодстайла:

![img](attachments/3.5.png)

## Part 4. Интеграционные тесты

#### Напиши этап для **CI**, который запустит интеграционные тесты.
##### Для проекта *C3_SimpleBashUtils* можешь взять свои уже написанные интеграционные тесты.
##### Запусти этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно.
##### Если тесты не прошли, то «зафейли» пайплайн.
##### В пайплайне отобрази вывод, что интеграционные тесты успешно прошли / провалились.

Обновленная структура файла **gitlab-ci.yml**:

![img](attachments/4.1.png)

После пуша коммита выполняется пайплайн с интеграционными тестами:

![img](attachments/4.2.png)

Логи тестов:

![img](attachments/4.3.png)

## Part 5. Этап деплоя

##### Подними вторую виртуальную машину *Ubuntu Server 22.04 LTS*.

Создал **prodserver** (клонировал **server** с генерацией новых MAC-адресов сетевых адаптеров) и запустил оба сервера:

![img](attachments/5.1.png)

Версия **Ubuntu** на **prodserver**:

![img](attachments/5.2.png)

Удалил **gitlab-runner** на **prodserver**:

![img](attachments/5.3.png)

#### Напиши этап для **CD**, который «разворачивает» проект на другой виртуальной машине.

##### Запусти этот этап вручную при условии, что все предыдущие этапы прошли успешно.

##### Напиши bash-скрипт, который при помощи **ssh** и **scp** копирует файлы, полученные после сборки (артефакты), в директорию */usr/local/bin* второй виртуальной машины.

Структура файла bash-скрипта **deploy.sh**:

![img](attachments/5.4.png)

Для того, чтобы копировать файлы при попомощи **scp** без ввода пароля генерирую пару ssh-ключей на сервере с **gitlab-runner** и копирую публичный ключ на **prodserver**:

![img](attachments/5.5.png)

Для того, чтобы на **prodserver** перемещать файлы из директории **/tmp** в директорию **/usr/local/bin** без ввода пароля добавляю в файл **/etc/sudoers** правило:

```
raynaldd ALL=(ALL:ALL) NOPASSWD: /usr/bin/mv /tmp/* /usr/local/bin
```

![img](attachments/5.6.png)

Файл **/etc/sudoers** изменен корректно:

![img](attachments/5.7.png)

##### В файле _gitlab-ci.yml_ добавь этап запуска написанного скрипта.

Обновленная структура файла **gitlab-ci.yml**:

![img](attachments/5.8.png)

После пуша коммита выполнется пайплайн с развертыванием:

![img](attachments/5.9.png)

Логи деплоя:

![img](attachments/5.10.png)

Проверяю наличие исполняемых файлов **s21_cat** и **s21_grep** на **prodserver**:

![img](attachments/5.11.png)

##### Сохрани дампы образов виртуальных машин.

![img](attachments/5.12.png)

## Part 6. Дополнительно. Уведомления

#### Настрой уведомления об успешном/неуспешном выполнении пайплайна через бота с именем «[твой nickname] DO6 CI/CD» в *Telegram*.

Создал телеграмм бота с помощью **@BotFather** c именем **raynaldd DO6 CI/CD**.

Для отправки отправки уведомлений создал bash-скрипт **tg_bot.sh**, в котором будет обращение к **API Telegram**:

![img](attachments/6.1.png)

Обновленная структура файла **gitlab-ci.yml**:

![img](attachments/6.2.png)
![img](attachments/6.3.png)

После пуша коммита выполнется пайплайн с рассылкой уведомлений:

![img](attachments/6.4.png)
![img](attachments/6.5.png)

Логи:

![img](attachments/6.6.png)
![img](attachments/6.7.png)

Уведомления в **Telegram**, содержащие информацию об успешности прохождения как этапа **CI**, так и этапа **CD**:

![img](attachments/6.8.png)
